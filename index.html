<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>AR Rescate</title>
        
        <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>

        <style>
            /* Debug visual para saber qué pasa */
            #debug-ui {
                position: fixed; top: 10px; left: 10px; z-index: 99999;
                background: rgba(0,0,0,0.8); color: red; padding: 10px;
                font-family: sans-serif; font-weight: bold; font-size: 20px;
                border-radius: 5px;
            }
        </style>

        <script>
            AFRAME.registerComponent('rescue-logic', {
                init: function () {
                    var marker = document.querySelector("#markerA");
                    var content = document.querySelector("#content-container");
                    var video = document.querySelector("#vid");
                    var model = document.querySelector("#animatedModel");
                    var debugText = document.querySelector("#debug-ui");
                    
                    var locked = false;

                    marker.addEventListener('markerFound', function() {
                        if(locked) return; // Si ya se activó, ignorar.

                        debugText.style.color = "lime";
                        debugText.innerText = "¡DETECTADO! ACTIVANDO...";

                        // 1. Obtener posición del marcador
                        var p = new THREE.Vector3();
                        var q = new THREE.Quaternion();
                        var s = new THREE.Vector3();
                        marker.object3D.getWorldPosition(p);
                        marker.object3D.getWorldQuaternion(q);
                        marker.object3D.getWorldScale(s);

                        // 2. Mover el contenido a esa posición
                        content.object3D.position.copy(p);
                        content.object3D.quaternion.copy(q);
                        content.object3D.scale.copy(s);

                        // 3. Hacer visible y reproducir
                        content.setAttribute('visible', 'true');
                        video.play();
                        if(model) model.setAttribute('animation-mixer', 'timeScale: 1');

                        // 4. Bloquear para que se quede ahí (Anti-vibración)
                        locked = true;
                        debugText.innerText = "FIJADO Y REPRODUCIENDO";
                    });
                }
            });

            // Ajuste simple de tamaño de video
            AFRAME.registerComponent('simple-video-fix', {
                init: function () {
                    var v = document.querySelector("#vid");
                    var p = this.el;
                    v.addEventListener('loadedmetadata', function() {
                        var ratio = v.videoHeight / v.videoWidth;
                        p.setAttribute('height', 8 * ratio); // 8 es el ancho fijo
                    });
                }
            });

            // Click para activar audio (necesario en móviles)
            window.addEventListener('click', function () {
                var v = document.querySelector("#vid");
                if(v) v.play();
            });
        </script>
    </head>

    <body style="margin: 0; overflow: hidden;">
        <div id="debug-ui">ESPERANDO MARCADOR...</div>

        <a-scene
            rescue-logic
            gesture-detector
            vr-mode-ui="enabled: false"
            embedded
            arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono; matrixCodeType: 3x3;"
            renderer="logarithmicDepthBuffer: true;">
            
            <a-assets>
                <video id="vid" src="assets/asset.mp4" preload="auto" loop crossorigin webkit-playsinline autoplay playsinline></video>
                <a-asset-item id="miModelo" src="assets/mi-modelo.glb"></a-asset-item>
            </a-assets>

            <a-entity light="type: ambient; intensity: 1;"></a-entity>
            <a-entity light="type: directional; intensity: 1.5; position: 1 1 1"></a-entity>

            <a-marker type="pattern" url="assets/marker.patt" id="markerA"></a-marker>

            <a-entity camera>
                <a-entity cursor="fuse: false; rayOrigin: mouse;" raycaster="objects: .clickable"></a-entity>
            </a-entity>

            <a-entity id="content-container" visible="false">
                
                <a-video 
                    src="#vid" 
                    simple-video-fix 
                    width="8"
                    rotation="-90 0 0" 
                    position="0 0 0">
                </a-video>

                <a-entity 
                    class="clickable"
                    gesture-handler="minScale: 0.25; maxScale: 10;"
                    position="0 0.5 1"> <a-entity 
                        id="animatedModel"
                        gltf-model="#miModelo" 
                        scale="0.04 0.04 0.04" 
                        rotation="-90 0 0"
                        animation-mixer="loop: repeat; timeScale: 0">
                    </a-entity>

                </a-entity>
            </a-entity>

        </a-scene>
    </body>
</html>
